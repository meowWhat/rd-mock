"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var Koa=require("koa"),bodyParser=require("koa-bodyparser"),Router=require("koa-router"),mockjs=require("mockjs"),low=require("lowdb"),FileSync=require("lowdb/adapters/FileSync"),fs=require("fs"),_=require("lodash");function _interopDefaultLegacy(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var Koa__default=_interopDefaultLegacy(Koa),bodyParser__default=_interopDefaultLegacy(bodyParser),Router__default=_interopDefaultLegacy(Router),low__default=_interopDefaultLegacy(low),FileSync__default=_interopDefaultLegacy(FileSync),fs__default=_interopDefaultLegacy(fs),___default=_interopDefaultLegacy(_);function __awaiter(e,u,i,l){return new(i=i||Promise)(function(r,t){function n(e){try{o(l.next(e))}catch(e){t(e)}}function a(e){try{o(l.throw(e))}catch(e){t(e)}}function o(e){var t;e.done?r(e.value):((t=e.value)instanceof i?t:new i(function(e){e(t)})).then(n,a)}o((l=l.apply(e,u||[])).next())})}function __generator(r,n){var a,o,u,e,i={label:0,sent:function(){if(1&u[0])throw u[1];return u[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(a)throw new TypeError("Generator is already executing.");for(;i;)try{if(a=1,o&&(u=2&t[0]?o.return:t[0]?o.throw||((u=o.return)&&u.call(o),0):o.next)&&!(u=u.call(o,t[1])).done)return u;switch(o=0,u&&(t=[2&t[0],u.value]),t[0]){case 0:case 1:u=t;break;case 4:return i.label++,{value:t[1],done:!1};case 5:i.label++,o=t[1],t=[0];continue;case 7:t=i.ops.pop(),i.trys.pop();continue;default:if(!(u=0<(u=i.trys).length&&u[u.length-1])&&(6===t[0]||2===t[0])){i=0;continue}if(3===t[0]&&(!u||t[1]>u[0]&&t[1]<u[3])){i.label=t[1];break}if(6===t[0]&&i.label<u[1]){i.label=u[1],u=t;break}if(u&&i.label<u[2]){i.label=u[2],i.ops.push(t);break}u[2]&&i.ops.pop(),i.trys.pop();continue}t=n.call(r,i)}catch(e){t=[6,e],o=0}finally{a=u=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}}fs__default.default.existsSync("db.json")&&fs__default.default.unlinkSync("db.json");var adapter=new FileSync__default.default("db.json"),db=low__default.default(adapter),DB=function(n){var a={},o=[];return Object.keys(n).forEach(function(e){var t=e.split("|")[0],r={};r[e]=n[e],a[t]=mockjs.mock(r)[t],o.push(t)}),db.defaults(a).write(),{db:db,keys:o}},matchOperators=function(e){var r=[/\_gte/,/\_lte/,/\_ne/,/\_like/,/\_num/];return Object.keys(e).filter(function(t){return r.some(function(e){return e.test(t)})})},_parseInt=function(e){return"string"==typeof e&&(e=Number.parseInt(e)),e},getSendData=function(e,t){return{rtn:e.code,data:t,msg:e.message}},filterQuery=function(e,t){var r=e[t];return void 0!==r?(delete e[t],r):null},isArr=function(e){return Array.isArray(e)&&0<e.length},isObj=function(e){return"object"==typeof e&&!isArr(e)&&isArr(Object.keys(e))},SUCCESS={code:0,message:"成功"},PARAM_IS_INVALID={code:10001,message:"参数无效"},PARAM_IS_BLANK={code:10002,message:"参数为空"},RESULT_DATA_NONE={code:50001,message:"数据未找到"},DATA_ALREADY_EXISTED={code:50003,message:"数据已存在"},INTERFACE_ADDRESS_INVALID={code:60004,message:"接口地址无效"},parseSort=function(e){var t=(filterQuery(e,"_sort")||"id").toString(),r="asc",n=filterQuery(e,"_order");return"asc"!==n&&"desc"!==n||(r=n),{sortKey:t,orderKey:r}},parseOperators=function(o){var u={};return matchOperators(o).forEach(function(e){var t=e.split("_"),r=t[0],n=t[1],a=o[e];delete o[e],Array.isArray(u[r])||(u[r]=[]),u[r].push({range:a,operators:n})}),u},parseSlice=function(e){var t=filterQuery(e,"_start"),r=filterQuery(e,"_end"),n=filterQuery(e,"_limit");return{start:t=null===t?-1:_parseInt(t),end:r=null===r?-1:_parseInt(r),limit:n=null===n?10:_parseInt(n)}},parsePaginate=function(e){var t=filterQuery(e,"_page");return{page:t=null===t?1:_parseInt(t)}},Get=function(y,p,e){e.get("/"+p,function(e,t){var r=y.get(p).value();if(""===e.querystring||!isArr(r))return e.body=getSendData(SUCCESS,r),t();var n=e.query,a=parsePaginate(n).page,o=parseSort(n),u=o.sortKey,i=o.orderKey,l=parseSlice(n),s=l.start,d=l.end,c=l.limit,f=parseOperators(n);if(isObj(n)&&(n.id&&(n.id=_parseInt(n.id)),r=___default.default.filter(r,n)),f){var _=Object.keys(f);isArr(_)&&(r=___default.default.filter(r,function(s){return _.every(function(l){return f[l].every(function(e){var t=e.range,r=e.operators,n=_parseInt(s[l]),a=s[l].toString(),o=_parseInt(t),u=t.toString(),i=!1;switch(r){case"gte":i=o<n;break;case"lte":i=n<o;break;case"ne":i=n!==o;break;case"like":i=a.includes(u);break;case"num":i=n===o}return i})})}))}-1!==s&&-1!==d&&(r=___default.default.slice(r,s,d)),r=___default.default.slice(r,(a-1)*c,a*c),r=___default.default.orderBy(r,u,i),isArr(r)?e.body=getSendData(SUCCESS,r):e.body=getSendData(RESULT_DATA_NONE,null),t()})},Post=function(o,u,e){e.post("/"+u,function(e,t){var r=e.request.body;if(r.id=r.id||Date.now(),isObj(r)){var n=o.get(u).value();if(isObj(n))if(Object.keys(r).every(function(e){return n[e]===r[e]}))e.body=getSendData(DATA_ALREADY_EXISTED,null);else{var a=[];a.push(n,r),o.set(u,a).write(),e.body=getSendData(SUCCESS,null)}else if(isArr(n)){o.get(u).find(r).value()?e.body=getSendData(DATA_ALREADY_EXISTED,null):(o.get(u).push(r).write(),e.body=getSendData(SUCCESS,null))}else e.body=getSendData(RESULT_DATA_NONE,null)}else e.body=getSendData(PARAM_IS_INVALID,null);t()})},Delete=function(a,o,e){e.delete("/"+o,function(e,t){var r=e.request.body;if(isObj(r)){var n=a.get(o).value();if(isObj(n))Object.keys(r).every(function(e){return n[e]===r[e]})?(a.unset(o).write(),e.body=getSendData(SUCCESS,null)):e.body=getSendData(RESULT_DATA_NONE,null);else if(isArr(n)){a.get(o).find(r).value()?(a.get(o).remove(r).write(),e.body=getSendData(SUCCESS,null)):e.body=getSendData(RESULT_DATA_NONE,null)}else e.body=getSendData(RESULT_DATA_NONE,null)}else e.body=getSendData(PARAM_IS_BLANK,null);t()})},Put=function(o,u,e){e.put("/"+u,function(e,t){var r=e.request.body;if(r&&void 0!==r.id){var n=o.get(u).value();if(isObj(n))o.get(u).assign(r).write(),e.body=getSendData(SUCCESS,null);else if(isArr(n)){var a=o.get(u).find({id:r.id}).value();isObj(a)?(o.get(u).find({id:r.id}).assign(r).write(),e.body=getSendData(SUCCESS,null)):e.body=getSendData(RESULT_DATA_NONE,null)}else e.body=getSendData(RESULT_DATA_NONE,null)}else e.body=getSendData(PARAM_IS_INVALID,null);t()})},router=new Router__default.default,getRoutes=function(e){var t=DB(e),r=t.db,n=t.keys;return router.get("/",function(e,t){e.body="\n      <h1>Rd-Mock</h1>\n      <h3>路由列表:</h3>\n      <ul>\n      "+n.map(function(e){return"<li>/"+e+"</li>"}).join("")+"\n      </ul>",e.set({"Content-Type":"text/html;charset=utf-8"}),t()}),n.forEach(function(e){Post(r,e,router),Delete(r,e,router),Put(r,e,router),Get(r,e,router)}),router.routes()},app=new Koa__default.default;app.use(bodyParser__default.default()),app.use(function(t,r){return __awaiter(void 0,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return"OPTIONS"===t.method&&(t.status=200),t.set({"Access-Control-Allow-Origin":"*","Access-Control-Allow-Headers":"Content-Type","Access-Control-Allow-Methods":"PUT,POST,GET,DELETE","Access-Control-Allow-Credentials":"true"}),t.body={},[4,r()];case 1:return e.sent(),[2]}})})}),app.use(function(t,r){return __awaiter(void 0,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return t.body={code:INTERFACE_ADDRESS_INVALID.code,message:INTERFACE_ADDRESS_INVALID.message,data:null},[4,r()];case 1:return e.sent(),[2]}})})});var rdMock=function(e,t){var r=t.delay,n=void 0===r?0:r,a=t.port,o=void 0===a?3e3:a,u=t.requestInterceptors,i=t.responseInterceptors;u&&u.forEach(function(e){app.use(e)}),app.use(function(t,r){return __awaiter(void 0,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,new Promise(function(e){setTimeout(function(){e(null)},n)})];case 1:return e.sent(),t.body={},[4,r()];case 2:return e.sent(),[2]}})})}),app.use(getRoutes(e)),i&&i.forEach(function(e){app.use(e)}),app.listen(o,function(){console.log("服务器成功启动于:http://localhost:"+o+"/")})};exports.rdMock=rdMock;
