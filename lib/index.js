"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var Koa=require("koa"),bodyParser=require("koa-bodyparser"),Router=require("koa-router"),mockjs=require("mockjs"),low=require("lowdb"),FileSync=require("lowdb/adapters/FileSync"),fs=require("fs"),_=require("lodash");function _interopDefaultLegacy(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var Koa__default=_interopDefaultLegacy(Koa),bodyParser__default=_interopDefaultLegacy(bodyParser),Router__default=_interopDefaultLegacy(Router),low__default=_interopDefaultLegacy(low),FileSync__default=_interopDefaultLegacy(FileSync),fs__default=_interopDefaultLegacy(fs),___default=_interopDefaultLegacy(_);function __awaiter(e,i,l,s){return new(l=l||Promise)(function(t,n){function r(e){try{o(s.next(e))}catch(e){n(e)}}function a(e){try{o(s.throw(e))}catch(e){n(e)}}function o(e){var n;e.done?t(e.value):((n=e.value)instanceof l?n:new l(function(e){e(n)})).then(r,a)}o((s=s.apply(e,i||[])).next())})}function __generator(t,r){var a,o,i,e,l={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return e={next:n(0),throw:n(1),return:n(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function n(n){return function(e){return function(n){if(a)throw new TypeError("Generator is already executing.");for(;l;)try{if(a=1,o&&(i=2&n[0]?o.return:n[0]?o.throw||((i=o.return)&&i.call(o),0):o.next)&&!(i=i.call(o,n[1])).done)return i;switch(o=0,i&&(n=[2&n[0],i.value]),n[0]){case 0:case 1:i=n;break;case 4:return l.label++,{value:n[1],done:!1};case 5:l.label++,o=n[1],n=[0];continue;case 7:n=l.ops.pop(),l.trys.pop();continue;default:if(!(i=0<(i=l.trys).length&&i[i.length-1])&&(6===n[0]||2===n[0])){l=0;continue}if(3===n[0]&&(!i||n[1]>i[0]&&n[1]<i[3])){l.label=n[1];break}if(6===n[0]&&l.label<i[1]){l.label=i[1],i=n;break}if(i&&l.label<i[2]){l.label=i[2],l.ops.push(n);break}i[2]&&l.ops.pop(),l.trys.pop();continue}n=r.call(t,l)}catch(e){n=[6,e],o=0}finally{a=i=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}([n,e])}}}fs__default.default.existsSync("db.json")&&fs__default.default.unlinkSync("db.json");var adapter=new FileSync__default.default("db.json"),db=low__default.default(adapter),DB=function(r){var a={},o=[];return Object.keys(r).forEach(function(e){var n=e.split("|")[0],t={};t[e]=r[e],a[n]=mockjs.mock(t)[n],o.push(n)}),db.defaults(a).write(),{db:db,keys:o}},matchOperators=function(e){var t=[/\_gte/,/\_lte/,/\_ne/,/\_like/,/\_num/];return Object.keys(e).filter(function(n){return t.some(function(e){return e.test(n)})})},_parseInt=function(e){return"string"==typeof e&&(e=Number.parseInt(e)),e},getSendData=function(e,n){return{rtn:e.code,data:n,msg:e.message}},filterQuery=function(e,n){var t=e[n];return void 0!==t?(delete e[n],t):null},isArr=function(e){return Array.isArray(e)&&0<e.length},isObj=function(e){return"object"==typeof e&&!isArr(e)&&isArr(Object.keys(e))},SUCCESS={code:0,message:"成功"},PARAM_IS_INVALID={code:10001,message:"参数无效"},PARAM_IS_BLANK={code:10002,message:"参数为空"},RESULT_DATA_NONE={code:50001,message:"数据未找到"},DATA_ALREADY_EXISTED={code:50003,message:"数据已存在"},INTERFACE_ADDRESS_INVALID={code:60004,message:"接口地址无效"},parseSort=function(e){var n=(filterQuery(e,"_sort")||"id").toString(),t="asc",r=filterQuery(e,"_order");return"asc"!==r&&"desc"!==r||(t=r),{sortKey:n,orderKey:t}},parseOperators=function(o){var i={};return matchOperators(o).forEach(function(e){var n=e.split("_"),t=n[0],r=n[1],a=o[e];delete o[e],Array.isArray(i[t])||(i[t]=[]),i[t].push({range:a,operators:r})}),i},parseSlice=function(e){var n=filterQuery(e,"_start"),t=filterQuery(e,"_end"),r=filterQuery(e,"_limit");return{start:n=null===n?-1:_parseInt(n),end:t=null===t?-1:_parseInt(t),limit:r=null===r?10:_parseInt(r)}},parsePaginate=function(e){var n=filterQuery(e,"_page");return{page:n=null===n?1:_parseInt(n)}},Get=function(_,y,e){e.get("/"+y,function(e,n){var t=_.get(y).value();if(""===e.querystring||!isArr(t))return e.body=getSendData(SUCCESS,t),n();var r=e.query,a=parsePaginate(r).page,o=parseSort(r),i=o.sortKey,l=o.orderKey,s=parseSlice(r),u=s.start,d=s.end,c=s.limit,f=parseOperators(r);if(isObj(r)&&(r.id&&(r.id=_parseInt(r.id)),t=___default.default.filter(t,r)),f){var p=Object.keys(f);isArr(p)&&(t=___default.default.filter(t,function(u){return p.every(function(s){return f[s].every(function(e){var n=e.range,t=e.operators,r=_parseInt(u[s]),a=u[s].toString(),o=_parseInt(n),i=n.toString(),l=!1;switch(t){case"gte":l=o<r;break;case"lte":l=r<o;break;case"ne":l=r!==o;break;case"like":l=a.includes(i);break;case"num":l=r===o}return l})})}))}-1!==u&&-1!==d&&(t=___default.default.slice(t,u,d)),t=___default.default.slice(t,(a-1)*c,a*c),t=___default.default.orderBy(t,i,l),isArr(t)?e.body=getSendData(SUCCESS,t):e.body=getSendData(RESULT_DATA_NONE,null),n()})},Post=function(o,i,e){e.post("/"+i,function(e,n){var t=e.request.body;if(t.id=t.id||Date.now(),isObj(t)){var r=o.get(i).value();if(isObj(r))if(Object.keys(t).every(function(e){return r[e]===t[e]}))e.body=getSendData(DATA_ALREADY_EXISTED,null);else{var a=[];a.push(r,t),o.set(i,a).write(),e.body=getSendData(SUCCESS,null)}else if(isArr(r)){o.get(i).find(t).value()?e.body=getSendData(DATA_ALREADY_EXISTED,null):(o.get(i).push(t).write(),e.body=getSendData(SUCCESS,null))}else e.body=getSendData(RESULT_DATA_NONE,null)}else e.body=getSendData(PARAM_IS_INVALID,null);n()})},Delete=function(a,o,e){e.delete("/"+o,function(e,n){var t=e.request.body;if(isObj(t)){var r=a.get(o).value();if(isObj(r))Object.keys(t).every(function(e){return r[e]===t[e]})?(a.unset(o).write(),e.body=getSendData(SUCCESS,null)):e.body=getSendData(RESULT_DATA_NONE,null);else if(isArr(r)){a.get(o).find(t).value()?(a.get(o).remove(t).write(),e.body=getSendData(SUCCESS,null)):e.body=getSendData(RESULT_DATA_NONE,null)}else e.body=getSendData(RESULT_DATA_NONE,null)}else e.body=getSendData(PARAM_IS_BLANK,null);n()})},Put=function(o,i,e){e.put("/"+i,function(e,n){var t=e.request.body;if(t&&void 0!==t.id){var r=o.get(i).value();if(isObj(r))o.get(i).assign(t).write(),e.body=getSendData(SUCCESS,null);else if(isArr(r)){var a=o.get(i).find({id:t.id}).value();isObj(a)?(o.get(i).find({id:t.id}).assign(t).write(),e.body=getSendData(SUCCESS,null)):e.body=getSendData(RESULT_DATA_NONE,null)}else e.body=getSendData(RESULT_DATA_NONE,null)}else e.body=getSendData(PARAM_IS_INVALID,null);n()})},indexHtmlTemplate='<html>\n<head>\n  <link\n    rel="stylesheet"\n    href="https://use.fontawesome.com/releases/v5.8.2/css/all.css"\n    integrity="sha384-oS3vJWv+0UjzBfQzYUhtDYW+Pj2yciDJxpsK1OYPAYjqT085Qq/1cq5FLXAZQ7Ay"\n    crossorigin="anonymous"\n  />\n  <title>JSON Server</title>\n</head>\n<style>\n  body {\n    display: flex;\n    min-height: 100vh;\n    font-family: -apple-system, BlinkMacSystemFont, \'Segoe UI\', Roboto,\n      Oxygen-Sans, Ubuntu, Cantarell, \'Helvetica Neue\', sans-serif;\n    flex-direction: column;\n    padding: 0;\n    margin: 0;\n    color: #3b4252;\n    letter-spacing: 0;\n  }\n\n  .container {\n    max-width: 960px;\n    margin: auto;\n    padding: 1rem;\n  }\n\n  header {\n    border-bottom: 1px solid #eee;\n  }\n\n  header a {\n    color: inherit;\n    text-decoration: none;\n  }\n\n  header a:hover {\n    text-decoration: underline;\n  }\n\n  nav ul {\n    display: flex;\n    flex-wrap: nowrap;\n    justify-content: space-between;\n  }\n\n  nav li.title {\n    flex-grow: 5;\n    text-align: left;\n    font-weight: bold;\n    font-size: 1.4rem;\n    color: #3b4252;\n  }\n\n  nav li {\n    flex-grow: 1;\n    align-self: center;\n    text-align: right;\n    color: #4c566a;\n  }\n\n  .fa-heart {\n    color: deeppink;\n  }\n\n  main {\n    flex: 1;\n  }\n\n  footer {\n    margin-top: 4rem;\n    border-top: 1px solid #eee;\n  }\n\n  h1 {\n    margin-top: 4rem;\n    font-weight: normal;\n  }\n\n  i {\n    margin-right: 0.5rem;\n  }\n\n  a {\n    color: #5e81ac;\n  }\n\n  a:hover {\n    color: #81a1c1;\n    text-decoration: underline;\n  }\n\n  table {\n    margin-left: 0;\n  }\n\n  td {\n    border: 0;\n    padding: 0 1em 0.5em 0;\n  }\n\n  td:first-child {\n    width: 1%;\n    white-space: nowrap;\n  }\n\n  ul {\n    list-style-position: inside;\n    padding-left: 0;\n  }\n\n  li {\n    list-style-type: none;\n    margin-bottom: 0.2rem;\n  }\n\n  code {\n    padding: 0.2rem;\n    margin: 0rem 0.2rem;\n    border-radius: 0.2rem;\n    background: #e5e9f0;\n  }\n</style>\n<body>\n  <header>\n    <div class="container">\n      <nav>\n        <ul>\n          <li class="title">rd-mock</li>\n          <li>\n            <a href="https://github.com/meowWhat/rd-mock/">\n              <i class="fas fa-heart"></i>GitHub\n            </a>\n          </li>\n          <li>\n            <a href="https://www.zhihu.com/people/chen-jia-hao-66-95">\n              <i class="fas fa-burn"></i>Contact\n            </a>\n          </li>\n        </ul>\n      </nav>\n    </div>\n  </header>\n  <main>\n    <div class="container">\n      <h1>Congrats!</h1>\n      <p>\n        You\'re successfully running rd-mock\n        <br />\n        ✧*｡٩(ˊᗜˋ*)و✧*｡\n      </p>\n      <h1>Resources</h1>\n      <div id="resources">\n      #resources#\n      </div>\n\n      <p>To access and modify resources, you can use these HTTP method:</p>\n      <p>\n        <code>GET</code>\n        <code>POST</code>\n        <code>PUT</code>\n        <code>DELETE</code>\n      </p>\n\n      <div id="custom-routes"></div>\n\n      <h1>Documentation</h1>\n      <p>\n        <a href="https://github.com/meowWhat/rd-mock/"> README </a>\n      </p>\n    </div>\n  </main>\n\n  <footer>\n    <div class="container">\n      <p>inspired by <code>json-serve</code> && <code>mockjs</code></p>\n    </div>\n  </footer>\n</body>\n</html>\n',router=new Router__default.default,getRoutes=function(e){var n=DB(e),t=n.db,r=n.keys;return router.get("/",function(e,n){var t="<ul>\n    "+r.map(function(e){return'<li><a href="/'+e+'">/'+e+"</a></li>\n"}).join("")+"\n    </ul>";e.body=indexHtmlTemplate.replace("#resources#",t),e.set({"Content-Type":"text/html;charset=utf-8"}),n()}),r.forEach(function(e){Post(t,e,router),Delete(t,e,router),Put(t,e,router),Get(t,e,router)}),router.routes()},app=new Koa__default.default;app.use(bodyParser__default.default()),app.use(function(n,t){return __awaiter(void 0,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return"OPTIONS"===n.method&&(n.status=200),n.set({"Access-Control-Allow-Origin":"*","Access-Control-Allow-Headers":"Content-Type","Access-Control-Allow-Methods":"PUT,POST,GET,DELETE","Access-Control-Allow-Credentials":"true"}),n.body={},[4,t()];case 1:return e.sent(),[2]}})})}),app.use(function(n,t){return __awaiter(void 0,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return n.body={code:INTERFACE_ADDRESS_INVALID.code,message:INTERFACE_ADDRESS_INVALID.message,data:null},[4,t()];case 1:return e.sent(),[2]}})})});var rdMock=function(e,n){var t=n.delay,r=void 0===t?0:t,a=n.port,o=void 0===a?3e3:a,i=n.requestInterceptors,l=n.responseInterceptors;i&&i.forEach(function(e){app.use(e)}),app.use(function(n,t){return __awaiter(void 0,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,new Promise(function(e){setTimeout(function(){e(null)},r)})];case 1:return e.sent(),n.body={},[4,t()];case 2:return e.sent(),[2]}})})}),app.use(getRoutes(e)),l&&l.forEach(function(e){app.use(e)}),app.listen(o,function(){console.log("服务器成功启动于:http://localhost:"+o+"/")})};exports.rdMock=rdMock;
