"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var Koa=_interopDefault(require("koa")),bodyParser=_interopDefault(require("koa-bodyparser")),Router=_interopDefault(require("koa-router")),mockjs=require("mockjs"),low=_interopDefault(require("lowdb")),FileSync=_interopDefault(require("lowdb/adapters/FileSync")),fs=_interopDefault(require("fs")),_=_interopDefault(require("lodash"));fs.existsSync("db.json")&&fs.unlinkSync("db.json");var adapter=new FileSync("db.json"),db=low(adapter),DB=function(n){var o={},a=[];return Object.keys(n).forEach(function(e){var t=e.split("|")[0],r={};r[e]=n[e],o[t]=mockjs.mock(r)[t],a.push(t)}),db.defaults(o).write(),{db:db,keys:a}},matchOperators=function(e){var r=[/\_gte/,/\_lte/,/\_ne/,/\_like/,/\_num/];return Object.keys(e).filter(function(t){return r.some(function(e){return e.test(t)})})},_parseInt=function(e){return"string"==typeof e&&(e=Number.parseInt(e)),e},getSendData=function(e,t){return{code:e.code,data:t,message:e.message}},filterQuery=function(e,t){var r=e[t];return void 0!==r?(delete e[t],r):null},isArr=function(e){return Array.isArray(e)&&0<e.length},isObj=function(e){return"object"==typeof e&&!isArr(e)&&isArr(Object.keys(e))},SUCCESS={code:1,message:"成功"},PARAM_IS_INVALID={code:10001,message:"参数无效"},PARAM_IS_BLANK={code:10002,message:"参数为空"},RESULE_DATA_NONE={code:50001,message:"数据未找到"},DATA_ALREADY_EXISTED={code:50003,message:"数据已存在"},INTERFACE_ADDRESS_INVALID={code:60004,message:"接口地址无效"},parseSort=function(e){var t=(filterQuery(e,"_sort")||"id").toString(),r="asc",n=filterQuery(e,"_order");return"asc"!==n&&"desc"!==n||(r=n),{sortKey:t,orderKey:r}},parseOperators=function(a){var s={};return matchOperators(a).forEach(function(e){var t=e.split("_"),r=t[0],n=t[1],o=a[e];delete a[e],Array.isArray(s[r])||(s[r]=[]),s[r].push({range:o,operators:n})}),s},parseSlice=function(e){var t=filterQuery(e,"_start"),r=filterQuery(e,"_end"),n=filterQuery(e,"_limit");return{start:t=null===t?-1:_parseInt(t),end:r=null===r?-1:_parseInt(r),limit:n=null===n?10:_parseInt(n)}},parsePaginate=function(e){var t=filterQuery(e,"_page");return{page:t=null===t?1:_parseInt(t)}},Get=function(S,A,e){e.get("/"+A,function(e,t){var r=S.get(A).value();if(""===e.querystring||!isArr(r))return e.body=getSendData(SUCCESS,r),t();var n=e.query,o=parsePaginate(n).page,a=parseSort(n),s=a.sortKey,i=a.orderKey,u=parseSlice(n),d=u.start,l=u.end,c=u.limit,f=parseOperators(n);if(isObj(n)&&(n.id&&(n.id=_parseInt(n.id)),r=_.filter(r,n)),f){var p=Object.keys(f);isArr(p)&&(r=_.filter(r,function(s){return p.every(function(a){return f[a].every(function(e){var t=e.range,r=e.operators,n=_parseInt(s[a]);t=_parseInt(t);var o=!1;switch(r){case"gte":o=t<n;break;case"lte":o=n<t;break;case"ne":o=n!==t;break;case"like":o=n.toString().includes(t.toString());break;case"num":o=n===t}return o})})}))}-1!==d&&-1!==l&&(r=_.slice(r,d,l)),r=_.slice(r,(o-1)*c,o*c),r=_.orderBy(r,s,i),isArr(r)?e.body=getSendData(SUCCESS,r):e.body=getSendData(RESULE_DATA_NONE,null),t()})},Post=function(o,a,e){e.post("/"+a,function(e,t){var r=e.request.body;if(r&&void 0!==r.id){var n=o.get(a).find({id:r.id}).value();n?e.body=getSendData(DATA_ALREADY_EXISTED,n):(o.get(a).push(r).write(),e.body=getSendData(SUCCESS,r))}else e.body=getSendData(PARAM_IS_BLANK,null);t()})},Delete=function(o,a,e){e.delete("/"+a,function(e,t){var r=e.request.body;if(r){var n=o.get(a).find(r).value();n?(o.get(a).remove(r).write(),e.body=getSendData(SUCCESS,n)):e.body=getSendData(RESULE_DATA_NONE,null)}else e.body=getSendData(PARAM_IS_BLANK,null);t()})},Put=function(n,o,e){e.put("/"+o,function(e,t){var r=e.request.body;r?void 0!==r.id?n.get(o).find({id:r.id}).value()?(n.get(o).find({id:r.id}).assign(r).write(),e.body=getSendData(SUCCESS,null)):e.body=getSendData(RESULE_DATA_NONE,null):e.body=getSendData(PARAM_IS_INVALID,null):e.body=getSendData(PARAM_IS_BLANK,null);t()})},router=new Router,getRoutes=function(e){var t=DB(e),r=t.db;return t.keys.forEach(function(e){Post(r,e,router),Delete(r,e,router),Put(r,e,router),Get(r,e,router)}),router.routes()},app=new Koa;app.use(bodyParser()),app.use(function(e,t){"OPTIONS"===e.method&&(e.status=200),e.set({"Access-Control-Allow-Origin":"*","Access-Control-Allow-Headers":"Content-Type","Access-Control-Allow-Methods":"PUT,POST,GET,DELETE","Access-Control-Allow-Credentials":"true"}),e.body={},t()}),app.use(function(e,t){e.body={code:INTERFACE_ADDRESS_INVALID.code,message:INTERFACE_ADDRESS_INVALID.message,data:null},t()});var rdMock=function(e,t){void 0===t&&(t=3e3),app.use(getRoutes(e)),app.listen(t,function(){console.log("Server is running at http://localhost:"+t+"/")})};exports.rdMock=rdMock;
